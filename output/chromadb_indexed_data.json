{
  "collection_name": "pyspark_code_chunks",
  "total_chunks": 1,
  "last_updated": "2025-11-23T19:11:21.250071",
  "indexed_chunks": [
    {
      "id": "tmpa91tsvss.py_chunk_0",
      "document": "# Databricks notebook source\n# dbutils.widgets.text(\"JobRunId\", '1')\n# dbutils.widgets.text(\"PipelineName\", 'Manual')\n# dbutils.widgets.dropdown('loadType','Full', ('Full','Incremental','Create'))\n# dbutils.widgets.text(\"startTime\", '01-01-0000')\n\n# COMMAND ----------\n\njobName = 'MOM_Alerts'\nconfigDict = {\n\t\t\"sourceName\": \"gold.o2c\",\n\t\t\"tableNamePrefix\": \"MOM\",\n\t\t\"tableNamePostfix\": \"Alerts\",\n\t\t\"sourceTables\": [ \"t_mom_purchase_order_alldates\",\"t_mom_sales_line_measures\" ],\n\t\t\"kernels\": [ \"MP1\" ],\n\t\t\"keyColumns\": { \n      \"t_mom_sales_line_measures\":[\"Sales_Document\", 'Item'],\n      \"t_mom_purchase_order_alldates\":[\"Purchasing_Doc\", 'Item'],\n     },\n\t\t\"notNullCols\": [ \"Sales_Document\" ],\n\t\t\"deleteKeys\": \"a.Sales_Document = b.Sales_Document\"\n\t}\n\n# COMMAND ----------\n\ndynamicDataDict = {\"selectList\": \"cast(Sales_Document as string) as Sales_Document ,cast(Item as string) as Item,cast(AlertDate as timestamp) as AlertDate,cast(AlertName as String) as AlertName,cast(ActionHolder as string) as ActionHolder,cast(AgingFlag as string)as AgingFlag\"}\n\n# COMMAND ----------\n\n# MAGIC %run ../../Common/NB_GL_Common\n\n# COMMAND ----------\n\nif dbutils.widgets.get(\"loadType\").lower() == \"create\":\n  status = dbutils.notebook.run(\"./NB_DD_GL_Creation_Alerts\", 90, {\"destinationTableName\":destinationTableName, \"destinationTablePath\": destinationTablePath})\n  if status == '0':\n    print(f\"\\x1b[32mThe table {destinationTableName} is created successfully in {destinationTablePath}\")\n  else:\n    print(\"\\x1b[31m *************The table creation failed*****************\")\n    isConfigAvail = False\n\nif isConfigAvail == False:\n  dbutils.notebook.exit(\"No Configuration Available is available or the NB encountered and unexpected issue\")\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC <h1>Implementation</h1>\n\n# COMMAND ----------\n\nspark.sql(f\"\"\"\ncreate or replace temporary view alldates as(\nselect cast(PrevABDate as date) as PrevABDate ,\n concat(Purchasing_Doc,'-',replace(LTRIM(replace(Item,'0',' ')),' ','0')) as Poitemkey from \n(select Purchasing_Doc,Item,ABConfirmationDate as PrevABDate,\nrow_number()over(partition by Purchasing_Doc,Item order by Snapshotdate desc) as rn\n from {catalog_table_name_gold}.{table_name_prefix_gold_src}purchase_order_alldates_archive ) p where rn=1\n )\n \"\"\"\n )\n\n# COMMAND ----------\n\nspark.sql(f\"\"\"\n          -- create or replace table alerts_temp as select 'Null' Sales_document, 'Null' Item, current_timestamp() AlertDate, 'Null' AlertName where False;\ncreate or replace temporary view mom_alerts_temp_vw as(\nselect distinct   \nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_01_PMRDD<>RDD' as AlertName,\nif(Sales_Doc_Type='ZPO' and COALESCE(ZZMSI,' ') ='X'\nand ZZPMRDD is not null and ZZPMRDD not in (' ','00000000') and ZZPMRDD<>RDD and ZZPMRDD>cast(getdate() as date),\nif (Zstatus in ('Z0','Z1','Z2','Z3','Z4'),'OM Action',  --<=Z4\nif (Zstatus in ('Z5','Z6','Z7','Z9','Z10') ,'PM Action',' ')),' ')   -->=Z5\n  as ActionHolder,\n'' as AgingFlag\nfrom  {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and if(Sales_Doc_Type='ZPO' and COALESCE(ZZMSI,' ') ='X'\nand ZZPMRDD is not null and ZZPMRDD not in (' ','00000000') and ZZPMRDD<>RDD and ZZPMRDD>cast(getdate() as date),'Y','N')='Y'\n-- changed as per 2512143 \n--(case when SalesDocumentType='ZPO' and isnull(MainSystemCheck,' ') ='X'\n-- and PMRDD is not null and PMRDD not in (' ','00000000') and PMRDD<>RDD and PMRDD>cast(getdate() as date) then 'Y' else 'N' end)='Y'\n\nunion all\n\n------PO_DUE----------\nselect  distinct\nSales_Document,\nItem \n,getdate() as AlertDate\n,'OM_02_PO_DUE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and\n--- GREEN PART ---\nif ((TECO IS NULL and FNBL IS NULL) and INCP='No' and (POBL='No' and (POBL_new='No'or POBL_new is null)) and Sales_Doc_Type in ('ZPO','ZSO','ZDM') \nand PORelevantFlag='Y' AND Purchasing_Doc is NULL and POFactory is null and DeliveryDocument is NULL and SUBSTRING(Item_Category, 2, 1) NOT IN ('C')\n, (case when (Business_Unit_Name in ('Diagnostic X Ray Equip','DXR Serv','Computed Tomography Equip'\n,'Computed Tomography Serv','Advanced Molecular Imaging Equip','Advanced Molecular Imaging Serv'\n,'Precision Diagnosis Other','Precision Diagnosis Solutions Serv'))\nand RDD<add_months(current_date(), 9) then 'Y' --DXR/CT\nWHEN ((Business_Unit_Name LIKE '%IGT%' AND Business_Unit_Name NOT LIKE '%Devices%') OR (`GMRU.Level7` LIKE '%IGT%' AND `GMRU.Level7` NOT LIKE '%Devices%'))  and RDD<add_months(current_date(), 18) then 'Y' -- IGT-S\nWHEN (\n    Business_Unit_Name LIKE '%HPM%' OR `GMRU.Level7` LIKE '%HPM%' OR\n    Business_Unit_Name IN ('Amb Monitoring & Diag') OR `GMRU.Level7` IN ('Amb Monitoring & Diag')\n) AND RDD < add_months(current_date(), 12) THEN 'Y' -- HPM AND AMD\n\n --- Blue part --- \nWHEN (\n  Business_Unit_Name IN ('Magnetic Resonance Imaging Equip', 'MRI Systems Serv','Ultrasound Equip', 'Ultrasound Serv', 'Ultrasound')\n  OR `GMRU.Level7` IN ('Magnetic Resonance Imaging Equip', 'MRI Systems','Ultrasound Equip', 'Ultrasound Serv', 'Ultrasound')\n  OR Business_Group_Name IN ('Clinical Informatics', 'Clinical Integration & Insights','Patient Care Informatics', 'Radiology Informatics','Imaging Informatics')\n  OR `GMRU.Level7` IN ('Clinical Informatics', 'Clinical Integration & Insights','Patient Care Informatics', 'Radiology Informatics','Imaging Informatics')\n) THEN 'Y' --MR, EI, and Ultrasound\n\nwhen  (Business_Unit_Name in ('IGT Devices','IGT Devices Systems','IGT Devices Undivided') or `GMRU.Level7` in ('IGT Devices','IGT Devices Systems','IGT Devices Undivided')) then 'N'\n--–IGT Devices needs to be excluded---\n\n--- Yellow part---\n\nwhen (\n Business_Unit_Name not like '%IGT%' and Business_Unit_Name not like '%HPM%' and `GMRU.Level7` not like '%HPM%' and `GMRU.Level7` not like '%IGT%'\n and Business_Unit_Name not in ('Diagnostic X Ray Equip','DXR Serv','Computed Tomography Equip','Computed Tomography Serv','Advanced Molecular Imaging Equip','Advanced Molecular Imaging Serv','Precision Diagnosis Other','Precision Diagnosis Solutions Serv')\n and `GMRU.Level7` not in ('Diagnostic X Ray Equip','DXR Serv','Computed Tomography Equip','Computed Tomography Serv','Advanced Molecular Imaging Equip','Advanced Molecular Imaging Serv','Precision Diagnosis Other','Precision Diagnosis Solutions Serv')\n and (Business_Unit_Name not in ('Amb Monitoring & Diag') or `GMRU.Level7` not in ('Amb Monitoring & Diag'))\n and (Business_Unit_Name not in ('Magnetic Resonance Imaging Equip','MRI Systems Serv','Ultrasound Equip','Ultrasound Serv','Ultrasound','Clinical Informatics','Clinical Integration & Insights','Patient Care Informatics','Radiology Informatics','Imaging Informatics') or `GMRU.Level7` not in ('Magnetic Resonance Imaging Equip','MRI Systems Serv','Ultrasound Equip','Ultrasound Serv','Ultrasound','Clinical Informatics','Clinical Integration & Insights','Patient Care Informatics','Radiology Informatics','Imaging Informatics') or `GMRU.Level7` is null)\n) and RDD < add_months(current_date(),6) then 'Y'\nelse 'N' end)\n,'N')='Y'\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_06_ON_HOLD' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and \n(case when (CFCOrgUnitValue='PCI' and Trim(Upper(OnHold))='YES') OR \n(CFCOrgUnitValue<>'PCI' and Material_grp_4 like '%OH%') then 'Y'else 'N'end )='Y'\n\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_07_CREDIT_HOLD' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures \nwhere OrderLineStatus='Open' and (case when OverallCredStat in ('B','C')then 'Y'else 'N' end)='Y'\n\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_08_Z4_DUE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open'and (case when Purchasing_Doc is NOT NULL \n--and MVGR3='001' \nand len(replace(LTRIM(replace(Material,'0',' ')),' ','0'))=6\nAND Business_Unit_Name not like '%Ultrasound%'\nand (len(COALESCE(Z4,''))=0  --software flag doesn't require Z4 check US:-2804096\nAND (lower(Software_Flag) in ('no') or Software_Flag is null) and len(COALESCE(Z5,''))=0  and len(COALESCE(Z6,''))=0 and len(COALESCE(Z7,''))=0 and len(COALESCE(Z8,''))=0 and len(COALESCE(Z9,''))=0 and len(COALESCE(Z10,''))=0)\nand Frozen_Period_Start_Date is not null AND  Frozen_Period_Start_Date<date_add(current_date(), 14)\nthen (case when  len(COALESCE(Z3,''))<>0  then 'Y'\n          when len(COALESCE(Z3,''))=0 and len(COALESCE(Z2,''))<>0 and Material_grp_3 IN ('002','001')  then'Y'\n           else'N'end)  --6NC\nelse 'N'end) ='Y' --BUG 2625823\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_09_FAC_TO_SITE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and  (case when Sales_Doc_Type in ('ZPO','ZSO','ZDM')\nAND storageLocationID='SITE' AND BackOrderCheck='No' AND DefoaFlag='N'  \nAND Purchasing_Doc is not null AND ABConfirmationDate  is not null \nAND CDD<=date_add(current_date(),1)\nAND (( RIGHT(Item_Category,1) in ('K','O','T','N')   and (ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null))\n   OR ( RIGHT(Item_Category,1) not in ('K','O','T','N') and  ActualGoodsIssueDate is null ))\nthen 'Y'else 'N' end  )='Y'\n\n\n\n \nunion all \nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_10_FAC_to_WHS' as AlertName\n,' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and (case when storageLocationID<>'SITE' \n\t\tAND  Sales_Doc_Type in ('ZPO','ZSO','ZDM')\n\t\tAND BackOrderCheck='No' AND DefoaFlag='N' and Purchasing_Doc is not null AND  ABConfirmationDate  is not null \n         and (Goods_Receipt is null or Goods_Receipt =' ' or (POHistory is null or POHistory not like '%E%') )and (Deliv_Compl is null or Deliv_Compl =' ')\n          and (ABConfirmationDate <= cast(current_date() as date)\n\t\t  or (ABConfirmationDate =date_add(current_date(),1) and Z7 is null and (COALESCE(POFactory,' ')<>' ' or POFactory is not null ) )\n\t\t  )then 'Y'  else 'N' end )='Y' --added poHistory logic on 09-16-22\n\n\nunion all \nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_11_DELIVERY' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and \n (case when storageLocationID<>'SITE' and Plant not in ('USMC','DEMC')  and COALESCE(Goods_Receipt,' ') not in (' ')\nand DeliveryDocument is null and Material <>'CHAPTER'\nand Goods_Issue<date_add(current_date(), 7)  then 'Y' else 'N' end)='Y'\n\n----------------------------------------------------------STEP 1(Till above)--------------------------------------------\n\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_16_SP00_REPLACE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and\n(case when Material in ('SP200','SP00200','SP00202','SP601','SP00601','SP787','SP100','SP202')\nthen 'Y'else 'N' end ) ='Y'\n\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_20_FAC_TO_MC' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and (case when (storageLocationID in ('MC','BBL1') OR Plant in ('USMC','DEMC')) AND date_diff(ABConfirmationDate,current_date())<0\nAND ABConfirmationDate is not null AND (Goods_Receipt is null or Goods_Receipt =' ' or (POHistory is null or POHistory not like '%E%') )  then 'Y'else 'N' end)='Y'\n\n\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_04_RDD<>CDD' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and (case when( CFCOrgUnitValue in('IS','US') and len(trim(Z2))>1 and storageLocationID='SITE' and RDD<>CDD)\nor (CFCOrgUnitValue in('IS','US') and len(trim(Z2))>1 and storageLocationID <>'SITE' \nand Len(Trim(storageLocationID))>1 and RequestedMaterialAvailabilityDate<>ABConfirmationDate )then 'Y' else 'N' end )='Y'\n\n\nunion all \n\nselect  distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_13_BACKORDER' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and ( case when Item_Category like 'YK%' \nand Usage in('02','03') and Overall_status in ('A','B') \nand  (Goods_Receipt is null or Goods_Receipt =' ' or (POHistory is null or POHistory not like '%E%') )\nthen 'Y' else 'N' end ) ='Y' --US 3234676\n\n\nunion all \nselect   distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_31_NAM_1_Merge_Confirmation' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open'  and (case when Sales_Org ='US90' and DeliveryDocument is null\nand storageLocationID in ('BA01','SZ03','EZ02','WZ03','SZ02','WZ04')  and SID <> '00000000'\nand date_diff(SID,current_date())<=13 and date_diff(SID,current_date())>=0\nthen 'Y'else 'N' end)  ='Y'\n\n\nunion all \nselect   distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n--,'OM_32_NAM_2_CDD<>SID' as AlertName -- commented as per qlik\n,'RRDD<>SID'as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open'  and (case when Sales_Org ='US90' and COALESCE(ZZMSI,' ') ='X' and Z10 is not null and SP00Identifier = 'N' \nand Modality='IS' and   RevisedRDDDate<>'00000000'and Len(Trim(RevisedRDDDate))>1 \nand (RevisedRDDDate <> SID --or CDD <> SID\n) then 'Y'else 'N' end)  ='Y' --US 2900298 comment CDD<>SID\n\n\nunion all \n\nselect   distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_33_NAM_3_Order_Completeness' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open'  and (case when Sales_Org ='US90'  \nand Modality='IS' and SID<>'00000000' and date_diff(SID,current_date())<=21 and date_diff(SID,current_date())>=0 \nand Item_Category  in ('YMCB','YMNC','YCLB') and  Len(COALESCE(GI_Processed,''))=0\nand COALESCE(Unrestricted_stock,0)<>COALESCE(Order_quantity,0) then 'Y' else 'N' end)  ='Y'\n\nunion all \nselect   distinct\nSales_Document,\nItem \n,current_date() as AlertDate\n,'OM_01_S67/P10' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and \nSales_Doc_Type in('ZPO','ZSO') and \n((case when Billing_Doc is  null then 'Y' when Billing_Doc is not null and date_part('MONTHS',Billing_Date)=date_part('MONTHS',current_date()) and date_part('YEAR',Billing_Date)=date_part('YEAR',current_date()) then 'Y'end )='Y') \nand coalesce(trim(Rejection_Reason), '') = '' and \n      (case when (Profit_Center = 'S67' OR substring(Product_Hierarchy, 9, 3) = 'S67') then 'Y'\n            when (Profit_Center != 'S67' OR substring(Product_Hierarchy, 9, 3) != 'S67')\n               then (\n                case when (Profit_Center = 'P10' OR substring(Product_Hierarchy, 9, 3) = 'P10')\n                  and (\n                        Material not in ('SP00210','SP00211','SP00212','SP00213','SP00214') or\n                        Material in ('SP00210','SP00211','SP00212','SP00213','SP00214') and right(WBSElementID,4)='0000'\n                  ) then 'Y'\n                else 'N' end\n               )\n            else 'N' end) ='Y'\n\nunion all\n\nselect   distinct\nSales_Document,\nItem \n,Getdate() as AlertDate\n,'OM_03_NO_AB_CONFIRMATION' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures \nwhere OrderLineStatus='Open' and (\n\tcase when Purchasing_Doc is null then 'N'\n      \twhen Purchasing_Doc is not null  and  COALESCE(PurchaseOrderDeletionIndicator,'')<>'L'\n      then(case when Purch_Group='12N' \n\t             then ( case when Rel_Strategy in( 'YA','YB','YC','YD','YE','YF')\n                              and Release_ind ='D' and datediff(getdate(),Changed_On)> 3\n\t\t\t\t\t\t\t   and  AbconfirmationDate is null and (Requisitioner in ('E','F','S') or Requisitioner is null or Requisitioner=' ')\n\t\t\t\t               and ActualGoodsReceiptDate is  null then 'Y' \n\t\t\t\t\t\t\t when  Rel_Strategy not in( 'YA','YB','YC','YD','YE','YF')\n\t\t\t\t\t\t\t       and datediff(getdate(),Changed_On)>3 and  AbconfirmationDate is null and (Requisitioner in ('E','F','S') or Requisitioner is null or Requisitioner=' ')\n\t\t\t\t                   and ActualGoodsReceiptDate is null then 'Y'\n\t\t\t\t\t\t\telse 'N'  end)\n\t\t\t\twhen Purch_Group ='US1' and Document_Type ='ZSUB' then 'N'\n\t\t\t\twhen Purch_Group<>'12N' and datediff(getdate(),Z1)>2 and\n\t\t\t\t   AbconfirmationDate is null and (Requisitioner in ('E','F','S') or Requisitioner is null or Requisitioner=' ' )\n\t\t\t\t   and ActualGoodsReceiptDate is null then 'Y'\n\t\t\t\t  else 'N' end)  else 'N' end)='Y'\n\nunion all\n\n\n--************************** No Data in synapse too *********************************\nselect distinct Sales_Document\n,Item,AlertDate,\nAlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom(select distinct  \nSales_Document\n,Item \n,Getdate() as AlertDate\n,'OM_03_ITEM_CRTD_AFTER_FNBL' as AlertName\n,if(Sales_Doc_Type='ZPO' and datediff(getdate(),Item_Created_On)<31\nand Header_Created_by<>'RIN_EPA500' and (Rejection_Reason is null or Rejection_Reason=' ')\nand teco is null and clsd is null and fnbl is not null \nand  (coalesce(Item_Created_On,' ')>fnbl)\nand (DefoaFlag <>'Y' and  BackOrderCheck <>'yes')\n, 'Y' , 'N' ) flag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere orderlinestatus='Open' )a where a.flag='Y'\n\nunion all\n--***************************select KUNNR from silverl2.funloc mpt working ****************************\nselect  distinct \nSales_Document\n,Item \n,Getdate() as AlertDate\n,'OM_04-ZPO/ZSO_OWN_FUNLOC' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere lower(trim(orderlinestatus))='open' and (case when Sales_Doc_Type in ('ZPO','ZSO') and \nreplace(LTRIM(replace(SoldToUser,'0',' ')),' ','0') in (select cast(KUNNR as int) from {catalog_table_name_sl2}.t_static_funloc)\n--and replace(LTRIM(replace(SoldToUser,'0',' ')),' ','0') not in ('94597888','94635281','94336547') --PFI check commented as per 2516110\nand concat(SoldToUser,Sales_Org)  in ('0000115384NL90','0000115914NL90','0000150291AU90','0000170174BE90','0000220153BG90','0000300278DK90','0000320401DE90'\n,'0000341124EG90','0000369052FI90','0000373816TW90','0000380121FR90','0000410505GR91','0000420181GB90','0000449251HU92'\n,'0000451610HK90','0000455053KR91','0000460167IE90','0000481520ID90','0000512908IL91','0000521525IT90','0000559295KE90'\n,'0000560003KE91','0000570285KR90','0000640714MY91','0000660402MX90','0000699022NZ90','0000710376NO90','0000716431AE90'\n,'0000720106AT90','0000771639PH90','0000781109PL90','0000790122PT90','0000801422NL90','0000813974RU90','0000819003RO90'\n,'0000825001SA91','0000830136SG90','0000850401ES90','0000890297TH90','0000910463CZ90','0000920749TR90','0000941093VN90'\n,'0000960537ZA91','0000970478SE90','0000980230CH90','0000982113CH90')\nthen 'Y' else 'N' end )='Y'\n\n\nunion all\n-- **************************** Working count synapse : 617 and Gold : 629 ************************\nselect  distinct \nSales_Document\n,Item \n,Getdate() as AlertDate\n,'OM_07_NO_WBS_FILLED' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere lower(trim(orderlinestatus))='open' \nand if(Sales_Doc_Type ='ZPO' \nand (SI_WBSElement is null or  SI_WBSElement ='00000000') \nand Billing_Doc is null and plant= Sales_Org and Item_Category  not in ('YINK','YINO','YICK','YICO')--Modified (Added few filters to ItemCategory) on 08/16/2022\n, 'Y' , 'N' )='Y'\n\nunion all\n-- ************** for somem of DeliveryCreateDate values show nill. So dat is not dispalying *************************\nselect  distinct\nSales_Document,\nItem \n,getdate() as AlertDate\n,'OM_RDD_Compliancy' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere lower(trim(orderlinestatus))='open' \nand (case when (teco is null or fnbl is null)  \nand datediff(getdate(),DeliveryCreateDate)<=14 and storageLocationID<>'SITE'\nand Terms_Of_Payment not in ('0007','Z090','Z990') and Shipment_Indicator not in ('DIR','MC','USMC') \nand Sales_Doc_Type not in ('ZDRM','ZPRO','ZSRO','ZDM') \nand plant not in ('DEMC','DX36','DX55','USMC','USM1') and Material not in ('CHAPTER-DX96','CHAPTER-IN90','CHAPTER-MANUAL')\nand RDD<>CDD and RDD>=Goods_Issue and RequestedMaterialAvailabilityDate<=RDD\nthen 'Y' else 'N' end )='Y'\n\nunion all\n\n--********************************* this is working but count is more n synapse : 352 in gold 23\nselect distinct \nSales_Document,\nItem \n,Getdate() as AlertDate\n,'OM_14_BOOKING_HORIZON' as AlertName,\ncase when datediff(getdate(),Item_Created_On)<=31 and datediff(RDD,getdate())> 457 then 'RDD > 15 Months' \nwhen datediff(getdate(),Item_Created_On)>31 and datediff(RDD,getdate()) > 810 then 'RDD > 27 Months'\nwhen datediff(getdate(),Item_Created_On)>31 and datediff(RDD,getdate()) > 720 then 'RDD > 24 Months' end as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere lower(trim(orderlinestatus))='open' and \nupper(INCP) ='NO' and Sales_Doc_Type in ('ZPO','ZSO','ZDM') and RDD is not null and coalesce(trim(Rejection_Reason), '') = '' and substring(Item_Category,2,1) not in ('1','2','3','X','Y','Z','I') and substring(Item_Category,4,1) in ('B','L','D','P') and FNBL is null AND Billing_Doc is null AND DeliveryDocument is null \nand ( case when datediff(getdate(),Item_Created_On) <=31 and datediff(RDD,getdate())>457 then 'Y' \nwhen datediff(getdate(),Item_Created_On)>31 and datediff(RDD,getdate())> 720 then 'Y'\nelse 'N' end )='Y'\n\nunion all\n-- *************** count matching synpase 38376 and in gold 38376 ****************************\nselect distinct \nSales_Document,\nItem \n,Getdate() as AlertDate\n,'OM_05_ALL_ORDERS_Y9' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere lower(trim(orderlinestatus))='open' and \n(case when datediff(getdate(),Item_Created_On)>2 and Header_Created_by<>'HYBRIS'\nand OrderOwner is null and (Overall_status like '%A%' or Overall_status like '%B%')\nand Business_Unit_Name not in ('Clinical Applications','Clinical Measurements','IGT Devices Systems')then 'Y' else 'N' end )='Y'\n\nunion all\n-- *************** count matching synpase 17 and in gold 26 ****************************\nselect distinct   \nSales_Document,\nItem \n,Getdate() as AlertDate\n,'OM_27_PO_NOT_APPROVED' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere orderlinestatus='Open' and (case when PORelevantFlag ='Y' and Purch_Group in ('12N','SSV','SPP') and \ndatediff(getdate(),Created_On)>1 and Rel_Strategy in ('YA','YB','YC','YD','YE','YF','O1','O2','O3','O4') \nand coalesce(Release_ind,' ')=0 then 'Y' else 'N' end )='Y' --Bug :-2878349\n\nunion all\n-- Need to create a table Purchase_Order_AllDates_Archive in implementaion notebook of Purchase_Order_AllDates\nselect  distinct\nSales_Document,\nItem \t\n,Getdate() as AlertDate\n,'OM_05_CHANGE_AB_CONFIRMATION' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures a\nleft join (select  PrevABDate ,Poitemkey from  alldates) b\non a.Poitemkey=b.poitemkey\nwhere lower(trim(orderlinestatus))='open'and \nif(ABConfirmationDate is not null \nand ABConfirmationDate<>b.PrevABDate and b.PrevABDate is not null \nand datediff(b.PrevABDate,ABConfirmationDate) between 0 and 7 , 'Y' , 'N' )='Y'\n\nunion all\n--********************************* this is working but count is more n synapse : 6155 in gold 8709\nselect distinct\nSales_Document,\nItem \n,getdate() as AlertDate\n,'OM_08_GI_OVERDUE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nleft join {catalog_table_name_sl2}.t_static_vendor_type A\non Trim(A.LIFNR)=cast((case when VendorID is null and coalesce(Fixed_vendor,'') <> '' then replace(Ltrim(replace(Fixed_vendor,'0',' ')),' ','0')\n      when vendorID is null and coalesce(Vendor_Account_Number,'') <> '' then replace(Ltrim(replace(Vendor_Account_Number,'0',' ')),' ','0')\n      else replace(Ltrim(replace(Vendor,'0',' ')),' ','0')end  )as int)\nwhere lower(trim(orderlinestatus))='open' and (case when GIRelevantFlag='Y' and (Rejection_Reason is null or Rejection_Reason =' ') and (date_part('month',BillingCreationDate)=date_part('month',getdate()) or \ndate_part('month',BillingCreationDate)=date_part('month',getdate())-1)\nthen (case when coalesce(A.VENDOR_TYPE,' ')=' ' then 'N'\n          when  coalesce(A.VENDOR_TYPE,' ')='CME' and storageLocationID ='SITE' \n          --GR relevance check GR Receipt = ‘No’\n\t\t\t\t\tthen (case when PoHistory not like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C' and ActualGoodsIssueDate is null  and Plant='DX96' \n                         and datediff(getdate(),BillingCreationDate)>3 then 'Y'\n                       --GR relevance check GR Receipt = ‘No’\n\t\t\t\t\t             when PoHistory not like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C'and ActualGoodsIssueDate is null  and Plant<>'DX96' then 'Y' \n                       --GR relevance check GR Receipt = ‘Yes’\n                       when PoHistory like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C' and ActualGoodsIssueDate is null and Plant='DX96' and datediff(getdate(),BillingCreationDate)>3 then 'Y'\n                       --GR relevance check GR Receipt = ‘yes’\n\t\t\t\t\t             when PoHistory like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C' and ActualGoodsIssueDate is null and Plant<>'DX96' then 'Y' else 'N' end\n                )\n          when coalesce(A.VENDOR_TYPE,' ')='CME' and  storageLocationID <> 'SITE' \n          --GR relevance check GR Receipt = ‘No’\n\t\t\t\t\tthen ( case when PoHistory not like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C'  and ActualGoodsIssueDate is null and Plant='DX96' and datediff(getdate(),BillingCreationDate)>3 then 'Y'\n\t\t\t\t\t            when PoHistory not like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C'  and ActualGoodsIssueDate is null and Plant<>'DX96' then 'Y' else 'N' end\n              )\n          when coalesce(A.VENDOR_TYPE,' ') not in ('CME') --and  storageLocationID <> 'SITE' \n          --GR relevance check GR Receipt = ‘No’\n\t\t\t\t\tthen ( case when PoHistory not like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C'  and ActualGoodsIssueDate is null and Plant='DX96' and datediff(getdate(),BillingCreationDate)>3 then 'Y'\n\t\t\t\t\t            when PoHistory not like'%E%' and coalesce(Total_goods_movement_status,' ')<>'C'  and ActualGoodsIssueDate is null and Plant<>'DX96' then 'Y'\n\t\t\t\t\t\t\t\t      when PoHistory not like'%E%'and Plant='USM1' and storageLocationID ='MAIN' and coalesce(Total_goods_movement_status,' ')<>'C'  and ActualGoodsIssueDate is null and Plant='DX96' and datediff(getdate(),BillingCreationDate)>3 then 'Y'\n\t\t\t\t\t\t\t\t     when PoHistory not like'%E%' and Plant='USM1' and storageLocationID ='MAIN' and coalesce \n                      (Total_goods_movement_status,' ')<>'C'  and ActualGoodsIssueDate is null and Plant<>'DX96' then 'Y' else 'N' end) else 'N'end \n               ) else 'N'\n\tend ) ='Y' \n\nunion all\n--*********************************As per US 3358600 GR_OVERDUE needs to be changed as GR_DUE. since these alerts are used in some of history tables, it cannot be renamed in Backend .Changes are done in powerbi for this****************\nselect\n      distinct Sales_Document,\n      Item,\n      getdate() as AlertDate,\n'OM_06_GR_OVERDUE' as AlertName, \ncase when Purchasing_Doc is not null\n          and Goods_Receipt = 'X'\n          and upper(Onhold) = 'NO'\n          and ActualGoodsReceiptDate is null then (\n            case\n              when storageLocationID = 'SITE'\n              and Acct_Grp IN ('ZNC1', 'ZNC2', 'ZNC4')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 4) then 'Philips Factory'\n              when storageLocationID = 'SITE'\n              and Vendor like ('%164728')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 15) then 'Resipronics'\n              when storageLocationID = 'SITE'\n              and coalesce(A.VENDOR_TYPE, '') = 'CME'\n              and Vendor like ('%168136')\n              and CDD <= date_add(current_date(), 4) then 'RDC' \n              when storageLocationID = 'SITE'\n              and coalesce(A.VENDOR_TYPE, '') <> 'CME'\n              and CDD <= date_add(current_date(), 14) then 'Third party Vendor' \n              when storageLocationID not in ('SITE')\n              and Plant not in ('USMC', 'DEMC')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 4) then 'Market Warehouse'\n              when storageLocationID not in ('SITE')\n              and Plant in ('USMC', 'DEMC')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 4) then 'Merge center'\n              else ' '\n            end\n          )\n          else ' '\n        end as ActionHolder,\n'' as AgingFlag\nfrom\n      {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nleft join {catalog_table_name_sl2}.t_static_vendor_type A  on Trim(A.LIFNR)=cast((case when VendorID is null and coalesce(Fixed_vendor,'') <> '' then replace(Ltrim(replace(Fixed_vendor,'0',' ')),' ','0')\n      when vendorID is null and coalesce(Vendor_Account_Number,'') <> '' then replace(Ltrim(replace(Vendor_Account_Number,'0',' ')),' ','0')\n      else replace(Ltrim(replace(Vendor,'0',' ')),' ','0')end  )as int)\n    where\n      lower(trim(orderlinestatus)) = 'open'\n      and (\n        case\n          when Purchasing_Doc is not null\n          and Goods_Receipt = 'X'\n          and upper(Onhold) = 'NO'\n          and ActualGoodsReceiptDate is null then (\n            case\n              when storageLocationID = 'SITE'\n              and Acct_Grp IN ('ZNC1', 'ZNC2', 'ZNC4')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 4) then 'Y' \n              when storageLocationID = 'SITE'\n              and Vendor like ('%164728')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 15) then 'Y' \n              when storageLocationID = 'SITE'\n              and coalesce(A.VENDOR_TYPE, '') = 'CME'\n              and Vendor like ('%168136')\n              and CDD <= date_add(current_date(), 4) then 'Y' \n              when storageLocationID = 'SITE'\n              and coalesce(A.VENDOR_TYPE, '') <> 'CME'\n              and CDD <= date_add(current_date(), 14) then 'Y'\n              when storageLocationID not in ('SITE')\n              and Plant not in ('USMC', 'DEMC')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 4) then 'Y'\n              when storageLocationID not in ('SITE')\n              and Plant in ('USMC', 'DEMC')\n              and ABConfirmationDate is not null\n              and ABConfirmationDate <= date_add(current_date(), 4) then 'Y'\n              else 'N'\n            end\n          )\n          else 'N'\n        end\n      ) = 'Y'\n\nunion all\n-- ********************************* this is working but count is more n synapse : 411 in gold 11418\nselect distinct   \nsl.Sales_Document,\nItem \n,Getdate() as AlertDate\n,'OM_19_GR_COMPLETE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures sl\nleft join\n(\nselect a.Sales_Document,array_join( collect_set(a.ActualGoodsReceiptDate), ',') as ActualGoodsReceiptDate\n  from  (\n      select distinct Sales_Document,case when ActualGoodsReceiptDate is not null then cast(ActualGoodsReceiptDate as string) else 'empty' end as ActualGoodsReceiptDate\n      from {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\n    )a\ngroup by a.Sales_Document\n)c\n on c.Sales_Document=sl.Sales_Document\nwhere OrderLineStatus='Open' and if((Delivery_block is not null  and Delivery_block <>' '),\nif(coalesce(Complete_dlv,' ') <>'X' and Delivery_group<>'0' and c.ActualGoodsReceiptDate not like '%empty%', 'Y'\n         ,if(Complete_dlv ='X' and c.ActualGoodsReceiptDate not like '%empty%', 'Y' , 'N' )), 'N' )='Y'--Bug 3021713\n    \nunion all\n-- ********************************* this is working but count is more n synapse : 2982 in gold 2698\nselect distinct\nSales_Document,\nItem \n,Getdate() as AlertDate\n,'OM_16_NO_CLEAN_ORDER_CODE' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures SM\nleft join {catalog_table_name_sl2}.t_static_cfc_orgunit_market A\non SM.Sales_Org=A.CompanyCode\nwhere lower(trim(orderlinestatus))='open'  and if(Sales_Doc_Type in ('ZPO','ZSO') --and trim(A.CFC) = 'CFC EMEA' \nand datediff(getdate(),Item_Created_On)<31 , if(Trim(SM.Market)  in ('Benelux','DACH','France','Italy','UKI','APAC','Greater China','Japan')\n--and Header_Created_by not in ('DEMICHAELIS','DEP18494','310243563','310105498','310116302','DEBADER','DERIMMELE')\nand COALESCE(Name_Of_Orderer,' ')=' ','Y', \nif(Trim(SM.Market) in ('LATAM','NAM') and DSR_Status = 'NO','Y','N')),'N')='Y'--2632575(23-08-2023)\n\nunion all\n-- ********************************* this is working but count is more n synapse : 1 in gold 212\nselect distinct\na.Sales_Document,\na.Item\n,Getdate() as AlertDate \n,'OM_34_CDD/rCDD >SID' as AlertName,\n' ' as ActionHolder,\ncase when coalesce(B.RCDD, ' ')= ' ' and (CDD > SID) \n                        then(case when  datediff(CDD,SID)<7  then 'Green'\n                                  when  datediff(CDD,SID) between 7 and 30 then 'Yellow'\n                                  when  datediff(CDD,SID)> 30 then 'Red' end)\n\t\t\twhen coalesce(B.RCDD, ' ')<>' 'and (cast(RCDD as date) > SID) then(case when  datediff(RCDD,SID)<7  then 'Green'\n                                  when  datediff(RCDD,SID) between 7 and 30 then 'Yellow'\n                                  when  datediff(RCDD,SID)> 30 then 'Red' end) \n\t\t\t  end as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures A\nleft join  (select x.Sales_Document,x.Sales_Document_Item,x.Rcdd,x.LegCount from\n(select Sales_Document,Sales_Document_Item,Rcdd,LegCount from {catalog_table_name_gold}.{table_name_prefix_gold_src}optilo_infodis_powerbi)x\njoin\n(select Sales_Document,Sales_Document_Item,max(LegCount) as LegCount from {catalog_table_name_gold}.{table_name_prefix_gold_src}optilo_infodis_powerbi group by Sales_Document,Sales_Document_Item)y\non x.Sales_Document=y.Sales_Document and x.Sales_Document_Item=y.Sales_Document_Item and x.LegCount=y.LegCount) B\non replace(ltrim(replace(A.Sales_Document, '0', ' ')), ' ', '0')=replace(ltrim(replace(B.Sales_Document, '0', ' ')), ' ', '0') and \nreplace(ltrim(replace(A.Item, '0', ' ')), ' ', '0')=replace(ltrim(replace(B.Sales_Document_Item, '0', ' ')), ' ', '0')\nwhere lower(trim(orderlinestatus))='open'  and \nif(`GMRU.Level7` not in  ('Ultrasound','US') and   -- Updated as per the incident- INC4050771\n\t\t Sales_Doc_Type in ('ZPRO','ZPO','YCQF') and --Material not like 'SP00%'  -- US 3086455\n    SP00Identifier = 'N' and A.Higher_lev_item <> '0' and A.Item_Category not in ('YXCN','YHC2','YHNB','YHNN','YINK','YSNN','YXCK','YYCK','YYDP','YYNK','YYNO','ZMNN','ZEDC') and (case when VendorID is not null and Acct_Grp in ('ZCPD','0001') then 'YES' --step1 \n      when coalesce(Fixed_vendor,'') not in ('')  and len(replace(Ltrim(replace(Fixed_vendor,'0',' ')),' ','0'))>6 then 'YES'  --step2 EBAN \n      when Indicator_Fixed_vendor='X' and len(replace(Ltrim(replace(Vendor_Account_Number,'0',' ')),' ','0'))>6 then 'YES' --step3 EORD \n      else 'NO' end)='NO' -- Thirdpartycheck \n      and Purchasing_Doc is not null\n      and SUBSTRING(Item_Category, 2, 1) NOT IN ('1', '2', '3')\n      and ((DeliveryType = 'Direct shipment' and LAConfirmationDate is null) or (DeliveryType = 'Via Warehouse' and DeliveryDocument is null))\n      and sid not in  (' ','00000000') \n\t\t , (case when coalesce(B.RCDD, ' ')= ' ' and (CDD > SID) then 'Y'\n\t\t\t\t\twhen B.RCDD is not null and (cast(RCDD as date) > SID) then 'Y' --Incident INC4089808\n\t\t\t  end) , 'N' ) ='Y'\n\n/*union all\n\n-- ********************************* this is working but count is more n synapse : 30449 in gold 63947\nselect  distinct  \nSales_Document,\nItem \n,Getdate() as AlertDate\n,'Order_Confirmation_Intime' as AlertName,\n' ' as ActionHolder\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere (case when lower(trim(orderlinestatus))='open' and  upper(INCP) ='NO' and coalesce(RDD,' ') <>'2035-12-31' and Purchasing_Doc is null and (Rejection_Reason is null or Rejection_Reason=' ') \nthen ( case when Sales_Doc_Type = 'ZSO' and datediff(CDD,Purchase_Order_Date)>11 then 'Y'\n            when Sales_Doc_Type = 'ZPO' and datediff(CDD,Purchase_Order_Date)>18 then 'Y' end )  \n            else 'N' end )='Y'*/  --updated as per 2996431  -- as per the BUG-3061824, commented this alert\n/*where lower(trim(orderlinestatus))='open' and if(upper(INCP) ='NO' and Sales_Doc_Type in ('ZPO','ZSO')  \nand Purchasing_Doc is null and (Rejection_Reason is null or Rejection_Reason=' ')  \nand datediff(getdate(),Item_Created_On)<31 \nand  coalesce(RDD,' ') <>'2035-12-31','Y','N')='Y'*/ --old code kept for reference \n\nunion all\n\n-- Need to check left join in synapse join is [O2CCommercial_GOMT_HVR].[ScheduleLines_RMAD_Archive]\nselect distinct   \nA.Sales_Document,\nA.Item \n,Getdate() as AlertDate\n,'RDD_Changed_3rd_Party' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures A\nleft join {catalog_table_name_gold}.{table_name_prefix_gold_src}Schedulelines_RMAD_Archive B\non A.Sales_Document=B.Sales_Document and A.Item=B.Item\nwhere lower(trim(orderlinestatus))='open' and if(Purchasing_Doc is not null and Purch_Group in ('12N','SSV','SPP')\n and A.RequestedMaterialAvailabilityDate <> B.RequestedMaterialAvailabilityDate\n and A.RequestedMaterialAvailabilityDate <> A.ConfirmedMaterialAvailabilityDate\n, 'Y' , 'N' )='Y'\n\nunion all\n\n-- ************************************ No data in synapes\nselect  distinct \nSales_Document\n,Item \n,Getdate() as AlertDate\n,'PO_DUE_3rd_Party' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures \nwhere lower(trim(orderlinestatus))='open' and\nif(Sales_Doc_Type in ('ZPO','ZSO','ZDM') and PORelevantFlag='Y' and Acct_Grp in ('0001')\nand Created_On is null and RDD<DATEADD(MONTH,6,current_date()) ,'Y'\n, 'N'  )='Y'\n\nunion all\n-- All FNBL values is null in coming from mom_zstatus_fnbl_teco_clsd\nselect  distinct \nSM.Sales_Document\n,Item \n,Getdate() as AlertDate\n,'FNBL_BUT_NOT_INVOICED' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures SM\nleft join (select sl.Sales_Document,sum(case when bl.Billing_Type in ('ZPMS','ZAIN') then bl.Billed_Qty else Null end) as InvoiceQty,max(case when Billing_Type ='ZDP' then 'Yes' else 'No' end) as ZPDFlag,sl.WBSElementID from {catalog_table_name_sl2}.{table_name_prefix_sl2_mp1}billing bl\njoin {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures sl\non  bl.Sales_Doc = sl.Sales_Document and cast(bl.Sales_Doc_Item as int)= cast(sl.Item as int) \nwhere bl.Billing_Type in ('ZPMS','ZDP','ZAIN')\ngroup by sl.Sales_Document,sl.WBSElementID ) B --US 3112002\non SM.Sales_Document=B.Sales_Document and SM.WBSElementID=B.WBSElementID\nwhere lower(trim(orderlinestatus))='open' and if(Sales_Doc_Type='ZPO' and Header_Created_by<>'RIN_EPA500'\nand coalesce(Rejection_Reason,' ')=' ' and fnbl is not null and\nBilling_Doc is null and  coalesce(Relevant_For_Billing,' ') <>' ' and (coalesce(cast(round(Order_quantity, 3) as int),'') <> coalesce(cast(round(InvoiceQty, 3) as int),'') or ZPDFlag='No')\n, 'Y', 'N')='Y' -- Incident:INC4123961\n\nunion all\n\nselect distinct   \nSales_Document,\nItem \n,Getdate() as AlertDate\n,'CAD_Not_Filled' as AlertName,\n' ' as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere lower(trim(orderlinestatus))='open' and\nDATEDIFF(HOUR, Item_Created_On, current_timestamp()) > 48 and\nif(( if(Sales_Doc_Type='ZPO' \nand left(Item_Category,2) in ('YS')\nand RIGHT(Item_Category,1) not in ('P','N') and Billing_Doc is null \nand coalesce(Rejection_Reason,' ')=' ' and coalesce(SI_WBSElement,' ') not in (' ','00000000')  and FNBL is null,'Y', 'N')='Y'\nOR if(Sales_Doc_Type='YCQF' and Higher_lev_item = '0'\nand coalesce(Rejection_Reason,' ')=' ' and coalesce(SI_WBSElement,' ') not in (' ','00000000'),'Y', 'N')='Y')\nand TECO is null and (Item_Created_On >=CAD or coalesce(CAD,' ') in (' ','00000000')), 'Y', 'N')='Y'\n\nunion all \n\nselect\n  distinct sales_document,\n  item,\n  Getdate() as AlertDate,\n  'Return_Not_Completed' as AlertName,\n  '' as ActionHolder,\n'' as AgingFlag\nfrom\n  {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures\nwhere\n  lower(OrderLineStatus) = 'open'\n  and (\n    case  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is null then 'YES' --'CASE1'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and Goods_Receipt is null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is NOT null then 'YES' --'CASE2'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and (   Goods_Receipt is null   or Goods_Receipt = ' ' ) and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is NOT null then 'YES' --'CASE3'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and Goods_Receipt is NOT NULL and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is null then 'YES' --'CASE4'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and Goods_Receipt is NOT NULL and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is not null then 'YES' --'CASE5'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and Goods_Receipt is NOT null and ActualGoodsReceiptDate is NOT null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null and datediff(getdate(), Item_Created_On) > 28 then 'YES' --'CASE6'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'NO' and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null and datediff(getdate(), Item_Created_On) > 28 then 'YES' --'CASE8'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'NO' and RelvReturnOrder = 'NO' and RelvReturnPO = 'NO' and RelvReturnDev = 'NO' and ActualGoodsIssueDate is null and datediff(getdate(), Item_Created_On) > 45 then 'YES' --'CASE9'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'NO' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is null and datediff(getdate(), Item_Created_On) > 45 then 'YES' --'CASE10'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and ActualGoodsReceiptDate is NOT null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null and datediff(getdate(), Item_Created_On) > 28 then 'YES' --'CASE11'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is null then 'YES' --'CASE12'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is NOT null and ActualMaintenanceDate is null then 'YES' --'CASE12.4'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and ActualGoodsIssueDate is NOT null and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is NOT null and datediff(getdate(), Item_Created_On) > 60 then 'CASE12.8'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'NO' and RelvReturnDev = 'NO' and ActualInvoiceReceiptDate is null and ActualMaintenanceDAte is null and datediff(getdate(), Item_Created_On) > 60 then 'YES' --'CASE13'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'NO' and RelvReturnDev = 'NO' and ActualInvoiceReceiptDate is NOT null then 'YES' --'CASE13.2'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'NO' and RelvReturnDev = 'NO' and ActualGoodsIssueDate is null and datediff(getdate(), Item_Created_On) > 45 then 'YES' --'CASE14'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'NO' and RelvReturnDev = 'NO' and ActualGoodsIssueDate is NOT null and datediff(getdate(), Item_Created_On) > 60 then 'YES' --'CASE14.2'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'NO' and Billing_Date is NOT null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null then 'YES' --'CASE15'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'NO' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is null and datediff(getdate(), Item_Created_On) > 45 then 'YES' --'CASE16'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is null then 'YES' --'CASE17'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is null and Goods_Receipt is NULL and ActualInvoiceReceiptDate is NOT null then 'YES' --'CASE18'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is null and Goods_Receipt is NULL and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null then 'YES' --'CASE18.2'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is NOT null and Goods_Receipt is NOT null and ActualGoodsReceiptDate is NOT null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null and datediff(getdate(), Item_Created_On) > 60 then 'YES' --'CASE19'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is NOT null and Goods_Receipt='X' and ActualGoodsReceiptDate is NOT NULL and  ActualInvoiceReceiptDate is null then 'YES' --'CASE20'   -- INC4373649 \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is NOT null and Goods_Receipt is NOT null and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is NOT null then 'YES' --'CASE21'  \nwhen Sales_Doc_Type in ('ZDRM', 'ZSRO', 'ZPRO') and coalesce(Rejection_Reason, ' ') = ' ' and RelvCustCredit = 'YES' and RelvReturnOrder = 'YES' and RelvReturnPO = 'YES' and RelvReturnDev = 'YES' and Billing_Date is NOT null and ActualGoodsIssueDate is NOT null and Goods_Receipt is NOT null and ActualGoodsReceiptDate is null and ActualInvoiceReceiptDate is null and ActualMaintenanceDate is null then 'YES' --'CASE22' else 'NO'\n    end\n  ) = 'YES'\n\n  union All\n  ----------US:2691098----------------\n  select distinct   \n Sales_Document,\nItem \n,current_date() as AlertDate\n,'PMRDD_NOT_FILLED' as AlertName,\nif(Sales_Doc_Type='ZPO' and COALESCE(ZZMSI,' ') ='X'\nand COALESCE(ZZPMRDD,' ') in (' ','00000000'),\nif (Zstatus in ('Z0','Z1','Z2','Z3','Z4'),'OM Action',  --<=Z4\nif (Zstatus in ('Z5','Z6','Z7','Z9','Z10') ,'PM Action',' ')),' ')   -->=Z5\n  as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and if(Sales_Doc_Type='ZPO' and `GMRU.Level7` not like '%US%' and COALESCE(ZZMSI,' ') ='X'\nand COALESCE(ZZPMRDD,' ') in (' ','00000000'),'Y','N')='Y'\n) --Bug 2900282,3150124\n\nunion All\n--US 3035806----------------------------------\nselect  distinct\nSales_Document\n,Item\n,getdate() as AlertDate\n,'FSR_Not_Filled_Or_Past' as AlertName\n, case when Sales_Doc_Type='ZSO' and Process_Type<>'700' and Zstatus in ('Z0','Z1','Z2','Z3','Z4')\n                     then 'Update Planned Billing Date (Hdr or ln)'  -- OM Action\n      when (Sales_Doc_Type='ZPO' or (Sales_Doc_Type='ZSO' and Process_Type='700')) and Zstatus in ('Z5','Z6','Z7','Z9','Z10') then 'Update FSR in PSA' --PM Action\n      else ' ' end as ActionHolder,\n'' as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}sales_line_measures\nwhere OrderLineStatus='Open' and (case when Sales_Doc_Type in ('ZPO') and FNBL is null and TECO is null  and Higher_lev_item='0' and (coalesce(FSR,' ' )=' ' or FSR < getdate()) then 'Y'\nwhen Sales_Doc_Type='ZSO' and Process_Type='700' and FNBL is null and TECO is null  and  Higher_lev_item='0' and (coalesce(FSR,' ' )=' ' or FSR < getdate()) then 'Y'\nwhen Sales_Doc_Type='ZSO' and Process_Type <> '700' and Billing_Doc is null and right(Item_Category,1) not in ('N','P') and (coalesce(FSR,' ' )=' ' or FSR < getdate()) then 'Y' else 'N' end)='Y'\n\nUNION ALL\n----------US:2691098----------------\nselect distinct\na.Sales_Document,\na.Item\n,Getdate() as AlertDate \n,'CDD/rCDD < SID (third party)' as AlertName,\n' ' as ActionHolder,\ncase when coalesce(B.RCDD, ' ')= ' ' and (CDD < SID) \n                        then(case when  datediff(SID,CDD)<7  then 'Green'\n                                  when  datediff(SID,CDD) between 7 and 30 then 'Yellow'\n                                  when  datediff(SID,CDD)> 30 then 'Red' end)\n\t\t\twhen coalesce(B.RCDD, ' ')<>' 'and (cast(RCDD as date) < SID) then(case when  datediff(SID,RCDD)<7  then 'Green'\n                                  when  datediff(SID,RCDD) between 7 and 30 then 'Yellow'\n                                  when  datediff(SID,RCDD)> 30 then 'Red' end) \n\t\t\t  end as AgingFlag\nfrom {catalog_table_name_gold}.{table_name_prefix_gold_src}Sales_Line_Measures A\nleft join  (select x.Sales_Document,x.Sales_Document_Item,x.Rcdd,x.LegCount from\n(select Sales_Document,Sales_Document_Item,Rcdd,LegCount from {catalog_table_name_gold}.{table_name_prefix_gold_src}optilo_infodis_powerbi)x\njoin\n(select Sales_Document,Sales_Document_Item,max(LegCount) as LegCount from {catalog_table_name_gold}.{table_name_prefix_gold_src}optilo_infodis_powerbi group by Sales_Document,Sales_Document_Item)y\non x.Sales_Document=y.Sales_Document and x.Sales_Document_Item=y.Sales_Document_Item and x.LegCount=y.LegCount) B\non replace(ltrim(replace(A.Sales_Document, '0', ' ')), ' ', '0')=replace(ltrim(replace(B.Sales_Document, '0', ' ')), ' ', '0') and \nreplace(ltrim(replace(A.Item, '0', ' ')), ' ', '0')=replace(ltrim(replace(B.Sales_Document_Item, '0', ' ')), ' ', '0')\nwhere lower(trim(orderlinestatus))='open'  and \nif(`GMRU.Level7` not in  ('Ultrasound','US') and\n\t\t Sales_Doc_Type in ('ZPRO','ZPO','YCQF') and\n    SP00Identifier = 'N' and A.Higher_lev_item <> '0' and A.Item_Category not in ('YXCN','YHC2','YHNB','YHNN','YINK','YSNN','YXCK','YYCK','YYDP','YYNK','YYNO','ZMNN','ZEDC') and (case when VendorID is not null and Acct_Grp in ('ZCPD','0001') then 'YES' --step1 \n      when coalesce(Fixed_vendor,'') not in ('')  and len(replace(Ltrim(replace(Fixed_vendor,'0',' ')),' ','0'))>6 then 'YES'  --step2 EBAN \n      when Indicator_Fixed_vendor='X' and len(replace(Ltrim(replace(Vendor_Account_Number,'0',' ')),' ','0'))>6 then 'YES' --step3 EORD \n      else 'NO' end)='YES' -- Thirdpartycheck \n      and sid not in  (' ','00000000') \n\t\t , (case when coalesce(B.RCDD, ' ')= ' ' and (CDD < SID) then 'Y'\n\t\t\t\t\twhen B.RCDD is not null and (cast(RCDD as date) < SID) then 'Y'\n\t\t\t  end) , 'N' ) ='Y'\n\"\"\"\n)\n\n# COMMAND ----------\n\ndef load_Model():\n  InsertLogs(applicationName,jobRunId,pipeline_name,jobName,loadType,startTime,endTime,'InProgress',f'Entered Load{jobName.replace(\"_\",\"\")}','',0,0,0,datetime.today())\n  if loadType == \"Full\":\n    joinQuery = \"\"\"\n      from mom_alerts_temp_vw       \n    \"\"\"\n  else:\n    joinQuery = f\"\"\"  FROM  {tempTableName} l \n      LEFT JOIN mom_alerts_temp_vw s\n      on l.Sales_Document = s.Sales_Document and l.item = s.item\n      \"\"\"\n\n  ## Calling function from common notebook\n  loadModelCommon(joinQuery=joinQuery, whereCondition='') \n\n# COMMAND ----------\n\nexecuteGold()",
      "metadata": {
        "chunk_id": "0",
        "start_token": "0",
        "end_token": "16732",
        "total_tokens": "16732",
        "total_file_tokens": "16732",
        "file_path": "C:\\Users\\320196~1\\AppData\\Local\\Temp\\tmpa91tsvss.py",
        "file_name": "tmpa91tsvss.py",
        "file_extension": ".py",
        "source_file": "NB_GL_Implementation_Alerts_p1.py"
      },
      "source_file": "NB_GL_Implementation_Alerts_p1.py",
      "indexed_at": "2025-11-23T19:11:21.250056"
    }
  ]
}